<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
 <title>Calendário de Reuniões</title>
<link rel="stylesheet" href="style.css">
  
</head>
<body>
  <h1>Calendário de Reuniões</h1>

  <div class="controls">
    <select id="salaSelect"></select>
    <button id="btnAtualizar">Atualizar</button>
  </div>

  <div id="salasContainer"></div>

  <footer id="status">Carregando...</footer>

  <script>
    const webhookUrl = "https://webhook.fiqon.app/webhook/9fff740d-92bb-4b53-a0ca-d250abefa7bf/f14ad3d0-f238-4dc7-adc4-ec4278c2d672";

    const salasFixas = [
      "IWS-3-Aliv (2)",
      "IWS-3-Bao Bao (6)",
      "IWS-3-Coluna Relax (6)",
      "IWS-3-Igloo (2)",
      "IWS-3-Magnum (8)",
      "IWS-3-Snow (12)",
      "IWS-4-Airgelly (2)",
      "IWS-4-Huggy (2)"
    ];

    let dadosSalas = [];

    const selectEl = document.getElementById("salaSelect");
    const statusEl = document.getElementById("status");
    const container = document.getElementById("salasContainer");

    function preencherDropdown() {
      selectEl.innerHTML = '<option value="todas">Ver todas as salas</option>';
      salasFixas.forEach(nome => {
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        selectEl.appendChild(opt);
      });
    }

    function mostrarSalas() {
      const filtro = selectEl.value;
      container.innerHTML = "";

      salasFixas.forEach(nomeSala => {
        if (filtro !== "todas" && filtro !== nomeSala) return;

        const salaData = dadosSalas.find(s => s.nome.trim().toLowerCase() === nomeSala.trim().toLowerCase());

        const div = document.createElement("div");
        div.className = "sala";
        div.innerHTML = `<h2>${nomeSala}</h2>`;

        if (salaData && salaData.reunioes?.length > 0) {
          salaData.reunioes.forEach(r => {
            const reuniao = document.createElement("div");
            reuniao.className = "reuniao";

            const agora = new Date();
            const inicio = new Date(r.inicio);
            const fim = new Date(r.fim);

            // Definir cor de fundo com !important para sobrescrever CSS externo
            if (fim < agora) {
              reuniao.style.setProperty('background-color', '#d3d3d3', 'important'); // cinza: já passou
            } else if (inicio <= agora && fim >= agora) {
              reuniao.style.setProperty('background-color', '#d4edda', 'important'); // verde claro: acontecendo
              reuniao.classList.add('ativo'); // animação e borda
            } else {
              reuniao.style.setProperty('background-color', '#eef5ff', 'important'); // azul claro: futura
            }

            reuniao.innerHTML = `
              <div class="hora">${formatarHora(r.inicio)} - ${formatarHora(r.fim)}</div>
              <div>${r.titulo}</div>
              <div class="organizador">
                Organizado por: ${r.organizador && r.organizador.toString().trim() ? r.organizador.toString().trim() : "Desconhecido"}
              </div>
            `;
            div.appendChild(reuniao);
          });
        } else {
          const vazio = document.createElement("div");
          vazio.className = "sem-reuniao";
          vazio.textContent = "Nenhuma reunião marcada.";
          div.appendChild(vazio);
        }

        container.appendChild(div);
      });
    }

    function formatarHora(iso) {
      if (!iso) return "--:--";
      const d = new Date(iso);
      return d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
    }

    async function carregarDados() {
      statusEl.textContent = "Atualizando...";
      try {
        const res = await fetch(webhookUrl, { cache: "no-store" });
        const json = await res.json();
        dadosSalas = Array.isArray(json.salas) ? json.salas : [];
        statusEl.textContent = "Última atualização: " + new Date().toLocaleString();
        mostrarSalas();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Erro ao carregar dados (veja o console).";
        mostrarSalas();
      }
    }

    preencherDropdown();
    selectEl.addEventListener("change", mostrarSalas);
    document.getElementById("btnAtualizar").addEventListener("click", carregarDados);

    mostrarSalas();
    carregarDados();
    
function agendarAtualizacao() {
  const agora = new Date();
  const hora = agora.getHours();

  // Só atualiza entre 7h e 23h
  if (hora >= 6 && hora <= 23) {
    carregarDados();
  }

  // Calcula quando será a próxima execução
  const minutos = agora.getMinutes();
  const segundos = agora.getSeconds();
  let msAteProximo = ((30 - (minutos % 30)) * 60 - segundos) * 1000;

  // Se for depois das 23h, agenda para 7h do dia seguinte
  if (hora > 23) {
    const proximoDia = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate() + 1, 7, 0, 0);
    msAteProximo = proximoDia - agora;
  }

  setTimeout(agendarAtualizacao, msAteProximo);
}

// Inicia o agendamento automático
agendarAtualizacao();

  </script>
</body>
</html>




